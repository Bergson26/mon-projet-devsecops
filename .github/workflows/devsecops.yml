name: Pipeline DevSecOps

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  secret-scanning:
    name: üïµÔ∏è Recherche de Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Scan Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sast-scan:
    name: üîç Analyse Statique (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        
      - name: Scan Semgrep CI
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/default"

  container-scan:
    name: üê≥ Build & Scan Docker (Trivy)
    runs-on: ubuntu-latest
    needs: [secret-scanning, sast-scan] 
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Build de l'image Docker temporaire
        run: docker build -t mon-app-securisee:${{ github.sha }} .

      - name: Scan des vuln√©rabilit√©s (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'mon-app-securisee:${{ github.sha }}'
          format: 'table'
          exit-code: '1' 
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  deploy:
    name: üöÄ Push vers GitHub Container Registry
    runs-on: ubuntu-latest
    needs: container-scan
    permissions:
      contents: read
      packages: write # Permission critique pour √©crire dans le registre
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Connexion √† GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Formater le nom du d√©p√¥t en minuscules
        run: |
          echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Build et Push de l'image s√©curis√©e
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWERCASE }}/mon-app-securisee:${{ github.sha }}
            ghcr.io/${{ env.REPO_LOWERCASE }}/mon-app-securisee:latest
